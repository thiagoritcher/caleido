<!DOCTYPE html>
<html lang="en-US">
<head>
</head>
<body>
<style>
.text_input{
	width: 50px;
	font-family: sans-serif;
	font-size: 13px;
	margin: 0px 10px 0px 0px;
}
.input_label {
	font-family: sans-serif;
	font-size: 13px;
	margin: 0px 3px 0px 0px;
}
</style>
<script type="text/javascript" >
var $ = function(id){
	return document.getElementById(id);
}

function Desenho(){
	this.traco_atual = new Traco();
	this.raio_atual = 5;
	this.cor_atual = "#000000";
	this.cor_fundo = "#ffffff";
	this.curvas_atuais = [20,20,20,20];
	this.repeticoes = 8;
	
	
	this.container = null;
	
	this.tracos = [this.traco_atual];
	this.draw = function(){
	    
		var ctx = this.container.getContext("2d");
		
		
		ctx.fillStyle=this.cor_fundo;
		ctx.fillRect(0, 0, this.container.width, this.container.height); 
		
		var i,j;
		for(j = 0; j < this.repeticoes; j++){
			
			for(i = 0; i < this.tracos.length; i++){
				this.tracos[i].draw(ctx);
			}
		    
			ctx.translate(this.container.width,0);
		    ctx.scale(-1, 1);
		    
		    for(i = 0; i < this.tracos.length; i++){
				this.tracos[i].draw(ctx);
			}
		    ctx.scale(-1, 1);
		    ctx.translate(-this.container.width,0);
		    
		   
			ctx.translate(this.container.width/2,this.container.height/2);
			ctx.rotate(Math.PI*2/this.repeticoes);
			ctx.translate(-this.container.width/2,-this.container.height/2);
			
		}
	    
	}
	
	this.add_ponto = function(e){
		var p = new Ponto();
		p.x = e.clientX - this.container.offsetLeft;
		p.y = e.clientY - this.container.offsetTop;
		p.raio = this.raio_atual;
		p.cor = this.cor_atual;
		p.curvas = this.curvas_atuais.slice(0);
		
		this.traco_atual.add_ponto(p);
		this.draw();
	}
	
	this.add_traco = function(){
		this.traco_atual = new Traco();
		this.tracos.push(this.traco_atual);
	}
}

function Traco(){
	this.pontos = []
	this.draw = function(ctx){
		var i;
		var ultimo, atual;
		for(i = 0; i < this.pontos.length; i++){
			atual = this.pontos[i]; 
			atual.draw(ctx);
			if(ultimo){
				ctx.moveTo(ultimo.x, ultimo.y);
				ctx.bezierCurveTo(ultimo.x + atual.curvas[0], ultimo.y + atual.curvas[1], 
						atual.x + atual.curvas[2], atual.y + atual.curvas[3], 
						atual.x, atual.y);
				
				//ctx.lineTo(atual.x,atual.y);
				ctx.strokeStyle = atual.cor;
				ctx.stroke();
			}
			ultimo = this.pontos[i];
		}
	}
	this.add_ponto = function(p){
		this.pontos.push(p);
	}
}

function Ponto(){
	this.x = null;
	this.y = null;
	this.raio = null;
	this.cor = null;
	
	this.p2 = 2*Math.PI;
	
	this.draw = function(ctx){
		ctx.beginPath();
		ctx.arc(this.x, this.y, this.raio, 0, this.p2, false);
		ctx.fillStyle = this.cor;
		ctx.fill();
	}
}

function Fields(){
	this.container = document.getElementById('fields');
	this.fields = {};
	this.buttons = [];
	
	this.create = function(){
		this.field('Cor', 'cor', "#000000", 'color');
		this.field('Raio', 'raio', 5);
		this.field('Fundo', 'fundo', "#ffffff", 'color');
		this.field('Repeticoes', 'repeticoes', 8);
		this.field('CA1', 'ca1', 20);
		this.field('CA2', 'ca2', 20);
		this.field('CB1', 'cb1', 20);
		this.field('CB2', 'cb2', 20);

		this.button('Atualizar');
		this.button('Traco');
		
		for(var i = 0; i < this.buttons.length; i++){
			var b = $(this.buttons[i]);
			b.o = this;
			b.addEventListener('click', this.handler, true);
		}
	}
	
	this.field = function(label, id, value, tipo){
		if(!tipo){
			tipo = 'text';
		}
		var html = '<label class="input_label" for="field_'+id+'">'+label+'</label><input type="'+tipo+'" value="'+value+'" name="field_'+id+'" id="field_'+id+'" class="text_input">';
		this.container.innerHTML += html;
		
		var fl = $('field_' + id);
		this.fields[id] = fl;
		
		//f.addEventListener('focus', this.act, true);
	}
	
	this.button = function(label){
		var id = label;
		var html = '<input type="button" value="'+label+'" id="button_'+id+'" name="'+id+'">';
		this.container.innerHTML += html;
		this.buttons.push('button_' + id);
	}
	
	this.handler = function(e){
		if(this.o.action){
			this.o.action.call(this.o, this.name)
		}
	}
	
}

window.onload = function(){
	var d = new Desenho();
	document.desenho = d;
	
	var c = document.getElementById('cv');
	c.width = window.innerWidth;
	c.height = window.innerHeight;
	
	d.container = c;
	
	c.addEventListener('mouseup', function(e) {
		document.desenho.add_ponto(e);
	}, false);
	
	
	var f = new Fields();
	f.create();
	f.action = function(id){
		if(id == 'Atualizar'){
			var d = document.desenho;
			d.cor_atual = $('field_cor').value;
			d.raio_atual = $('field_raio').value;
			d.cor_fundo = $('field_fundo').value;
			d.repeticoes = $('field_repeticoes').value;
			d.curvas_atuais = [parseInt($('field_ca1').value), parseInt($('field_ca2').value), parseInt($('field_cb1').value), parseInt($('field_cb2').value)];
			
			d.draw();
		}
		if(id == 'Traco'){
			var d = document.desenho;
			d.add_traco();
		}
	}		
	document.fields = f;
	
	
	
	d.draw();
}

</script>
<div id="fields" style="position: absolute; background-color: white;"></div>
<canvas width="100" height="100" id="cv"></canvas>
</body>
</html>